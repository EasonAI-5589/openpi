# 每日总结 2024-12-29

> 郭奕辰 | OpenPI + ManiSkill3 集成项目

---

## 今日核心工作

### 问题排查：Pi0.5 PickCube 训练 loss 降但评估 0%

#### 排查过程

1. **检查 wrist_image 一致性**
   - 读取训练数据 parquet 文件
   - 发现 wrist_image 列全为零
   - **结论**：训练和评估的 wrist_image 都是全零，一致 ✅

2. **使用云帆 checkpoint 验证**
   - 使用云帆的 Pi0 PickCube checkpoint 评估
   - 结果：0% (0/20)
   - 检查云帆视频目录：全部是 failure
   - **结论**：云帆的 PickCube 也是 0%，之前文档的 18.5% 存疑

3. **使用云帆 StackCube checkpoint 验证**
   - 结果：**15% (3/20)** ✅
   - **结论**：评估流程没问题，StackCube 能跑出成功率

#### 最终结论

| 问题假设 | 验证结果 |
|----------|----------|
| wrist_image 训练/评估不一致 | ❌ 都是全零，一致 |
| Pi0 vs Pi0.5 差异 | ❌ 云帆 Pi0 PickCube 也是 0% |
| 评估流程有问题 | ❌ StackCube 能跑出 15% |
| **PickCube 任务本身较难** | ✅ 这是真正原因 |

---

## 验证结果汇总

| Task | Checkpoint | 成功率 |
|------|------------|--------|
| StackCube | 云帆 Pi0 (9500 steps) | **15% (3/20)** ✅ |
| PickCube | 云帆 Pi0 (26000 steps) | 0% (0/20) |
| PickCube | 云帆 Pi0_50 (29999 steps) | 0% (0/20) |
| PickCube | 我们 Pi0.5 (29999 steps) | 0% (0/50) |

---

## 文档更新

1. **BENCHMARK_REPORT.md**
   - 添加 2024-12-29 验证结果
   - 更新下一步计划

2. **ISSUES_2024-12-28.md**
   - 修正 PickCube 18.5% 成功率的错误
   - 添加验证过程和结论
   - 更新可能原因总结

3. **TODO.md**
   - 添加 2024-12-29 进度
   - 标记完成的任务

---

## 下一步计划

1. ~~**问云帆**：18.5% PickCube 成功率是怎么跑出来的？~~ ✅ 已回复
2. **用 StackCube 配置训练 Pi0.5**：action_horizon=20 + 带 wrist
3. 验证 Pi0.5 能否达到类似 Pi0 的效果

---

## 云帆回复（19:50）

> "你需要先训练一个 pi0.5 然后测试一下"

### 云帆分享的配置路径
- 代码库：`/share/project/yunfan/RL/caurft/openpi`
- 配置文件：`/share/project/yunfan/RL/caurft/openpi/src/openpi/training/config.py`

### 关键发现：StackCube 配置不同！

| 任务 | action_horizon | data_config | 成功率 |
|------|----------------|-------------|--------|
| **StackCube** | **20** | **LeRobotManiskillDataConfig**（带 wrist） | **15%** ✅ |
| PickCube | 10 | NoWristDataConfig | 0% |
| PlaceSphere | 10 | NoWristDataConfig | 0% |

**这解释了为什么 StackCube 能成功而 PickCube 失败！**

### 云帆的 StackCube 配置（成功）
```python
TrainConfig(
    name="pi0_maniskill_stackcube",
    model=pi0_config.Pi0Config(action_horizon=20),  # 注意是 20！
    data=LeRobotManiskillDataConfig(  # 带 wrist！
        repo_id="/share/project/yunfan/RL/maniskill_lerobot/maniskill_stackcube",
        base_config=DataConfig(prompt_from_task=True),
        extra_delta_transform=False,
    ),
    batch_size=256,
    num_train_steps=30_000,
    weight_loader=weight_loaders.CheckpointWeightLoader(
        "/share/project/yunfan/RL/caurft/openpi/checkpoints/pi0_base/..."
    ),
)
```

### 云帆的 PickCube 配置（失败）
```python
TrainConfig(
    name="pi0_maniskill_pickcube",
    model=pi0_config.Pi0Config(action_horizon=10),  # 只有 10
    data=LeRobotManiskillNoWristDataConfig(...),    # 无 wrist
    batch_size=256,
    num_train_steps=30_000,
)
```

---

## 关键命令

### 成功的 StackCube 评估命令
```bash
CUDA_VISIBLE_DEVICES=0 \
PYTHONPATH=/share/project/yunfan/RL/caurft/openpi/src:$PYTHONPATH \
python /share/project/yunfan/RL/caurft/openpi/scripts/eval_maniskill.py \
    --config-name pi0_maniskill_stackcube \
    --checkpoint-dir /share/project/yunfan/RL/caurft/openpi/checkpoints/pi0_maniskill_stackcube/stackcube/9500 \
    --env-id StackCube-v1 \
    --num-episodes 20 \
    --save-video False \
    --prompt "Pick up a red cube and stack it on top of a green cube and let go of the cube without it falling" \
    --sim-backend cpu
```

### 检查训练数据 wrist_image
```python
import pandas as pd
from PIL import Image
import io
import numpy as np

df = pd.read_parquet('/share/project/guoyichen/maniskill_lerobot/maniskill_pickcube/data/chunk-000/episode_000000.parquet')
wrist_data = df['wrist_image'].iloc[0]
img = Image.open(io.BytesIO(wrist_data['bytes']))
arr = np.array(img)
print(f'wrist_image min: {arr.min()}, max: {arr.max()}')  # 0, 0 → 全零
```

---

## 时间线

| 时间 | 工作内容 |
|------|----------|
| 下午 | 排查 wrist_image 一致性问题 |
| 下午 | 使用云帆 checkpoint 验证评估流程 |
| 傍晚 | 更新所有相关文档 |
| 19:50 | 收到云帆回复，分析配置差异 |
| 19:55 | 修改所有 Pi0.5 ManiSkill 配置 |

---

## 配置修改（19:55）

根据云帆的建议，修改所有 Pi0.5 ManiSkill 配置：

| 任务 | 修改前 | 修改后 |
|------|--------|--------|
| PickCube | action_horizon=10, NoWrist | **action_horizon=20, 带 wrist** |
| PushCube | action_horizon=10, NoWrist | **action_horizon=20, 带 wrist** |
| PullCube | action_horizon=10, NoWrist | **action_horizon=20, 带 wrist** |
| PlaceSphere | action_horizon=10, NoWrist | **action_horizon=20, 带 wrist** |
| PegInsertionSide | action_horizon=10, NoWrist | **action_horizon=20, 带 wrist** |
| StackCube | action_horizon=20, 带 wrist | 无需修改 ✅ |

**修改文件**：`src/openpi/training/config.py`

---

## Pi0.5 StackCube 训练启动（20:10）

### 训练配置

| 配置项 | 值 |
|--------|-----|
| 配置名 | `pi05_maniskill_stackcube` |
| 实验名 | `stackcube_sft_v1` |
| action_horizon | 20 |
| batch_size | 128 |
| fsdp_devices | 8 (8x H100 80GB) |
| num_train_steps | 30,000 |
| 数据 | LeRobotManiskillDataConfig（带 wrist） |

### 启动命令

```bash
source /share/project/guoyichen/miniconda3/bin/activate openpi
CUDA_VISIBLE_DEVICES=0,1,2,3,4,5,6,7 nohup python scripts/train.py \
    pi05_maniskill_stackcube \
    --exp-name stackcube_sft_v1 \
    --no-wandb-enabled \
    --overwrite > nohup_stackcube.out 2>&1 &
```

### 当前训练状态（20:30）

| 指标 | 值 |
|------|-----|
| 进度 | 117/30000 steps |
| 初始 Loss | 0.0702 |
| 当前 Loss | 0.0573 (↓18%) |
| 速度 | ~5.2s/step |
| GPU 显存 | 8卡 × 65GB |
| 预计剩余 | **~43 小时** |

### 为什么比 PickCube 慢？

| 因素 | PickCube (之前) | StackCube (现在) |
|------|-----------------|------------------|
| action_horizon | 10 | **20** (翻倍) |
| wrist_image | 无 | **有** |
| 速度 | ~1.2s/step | **~5.2s/step** |
| 预计时间 | ~10 小时 | **~43 小时** |

**原因**：按云帆成功配置（action_horizon=20 + 带 wrist），计算量比之前大约 4 倍。

### Checkpoint 路径

```
/share/project/guoyichen/openpi/checkpoints/pi05_maniskill_stackcube/stackcube_sft_v1/
```

### 监控命令

```bash
# 查看实时日志
tail -f nohup_stackcube.out

# 检查 GPU 状态
nvidia-smi

# 检查进度
tail -5 nohup_stackcube.out
```

---

## 下一步计划（待训练完成后）

1. **评估 Pi0.5 StackCube**
   ```bash
   python scripts/eval_maniskill.py \
       --config-name pi05_maniskill_stackcube \
       --checkpoint-dir checkpoints/pi05_maniskill_stackcube/stackcube_sft_v1/29999 \
       --env-id StackCube-v1 \
       --num-episodes 20
   ```

2. **对比目标**：云帆 Pi0 StackCube 15% 成功率

3. **如果成功**：用相同配置训练其他任务（PickCube, PushCube 等）

---

## 时间线（完整）

| 时间 | 工作内容 |
|------|----------|
| 下午 | 排查 wrist_image 一致性问题 |
| 下午 | 使用云帆 checkpoint 验证评估流程 |
| 傍晚 | 更新所有相关文档 |
| 19:50 | 收到云帆回复，分析配置差异 |
| 19:55 | 修改所有 Pi0.5 ManiSkill 配置 |
| **20:10** | **启动 Pi0.5 StackCube 训练** |
| 20:30 | 确认训练正常运行，预计 43 小时完成 |

---

*生成时间: 2024-12-29*
*最后更新: 2024-12-29 20:30*
