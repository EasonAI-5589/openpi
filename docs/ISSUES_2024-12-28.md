# Pi0.5 ManiSkill 评估问题记录 (2024-12-28)

## 问题概述

**PickCube 任务评估成功率为 0%**

| 指标 | 值 |
|------|-----|
| 成功率 | 0/50 = **0%** |
| 每个 episode | 跑满 500 步超时 |
| 平均时间 | 11.79s/episode |

## 训练情况（正常）

训练本身正常完成：

| Step | Loss | Grad Norm |
|------|------|-----------|
| 0 | 0.0833 | 0.8746 |
| 29900 | 0.0045 | 0.0526 |

- Loss 下降 **95%**（0.0833 → 0.0045）
- 训练时长：9小时46分
- Checkpoint：`checkpoints/pi05_maniskill_pickcube/pickcube_sft_v1/29999`

## 问题排查

### 1. wrist_image 全黑 ⚠️

评估时 `wrist_image` 是全黑图像：

![base_image](../debug_images/base_image.jpg) - 正常
![wrist_image](../debug_images/wrist_image.jpg) - **全黑**

**原因**：评估环境没有配置 `hand_camera`，代码回退到零图像

```python
# eval_maniskill.py:120-122
if wrist is not None:
    inputs["observation/wrist_image"] = np.asarray(wrist)
else:
    # Use a zero image fallback - 这里返回全黑
    inputs["observation/wrist_image"] = np.zeros((h, w, 3), dtype=np.uint8)
```

**训练数据有 wrist_image**：
```
Columns: ['image', 'wrist_image', 'state', 'actions', ...]
```

### 2. action_horizon 配置差异 ⚠️

| 配置项 | 我们 (Pi0.5 PickCube) | 云帆 (Pi0 StackCube) |
|--------|----------------------|---------------------|
| action_horizon | **10** | **20** |
| data_config | LeRobotManiskillNoWristDataConfig | LeRobotManiskillDataConfig |
| batch_size | 128 | 256 |
| fsdp_devices | 8 | 1 (默认) |

评估脚本中 `max_actions_to_execute = 20`，但模型输出可能只有 10 个 actions。

### 3. 云帆的评估结果对比

云帆 StackCube 最新结果：
- **25 success / 91 total ≈ 27.5%**

说明他的训练和评估流程是有效的。

## 云帆 PickCube 结果（对比）

云帆用 **Pi0**（非 Pi0.5）训练的 PickCube：

| 指标 | 值 |
|------|-----|
| Success | 37 |
| Failure | 163 |
| **成功率** | **18.5%** |

**云帆配置**：
```python
TrainConfig(
    name="pi0_maniskill_pickcube",
    model=pi0_config.Pi0Config(action_horizon=10),  # Pi0, 非 Pi0.5
    data=LeRobotManiskillNoWristDataConfig(...),    # 和我们一样
    batch_size=256,
    ...
)
```

## 可能原因总结

| 可能原因 | 概率 | 说明 |
|----------|------|------|
| **Pi0 vs Pi0.5 差异** | **高** | 云帆用 Pi0 有效，我们用 Pi0.5 失败 |
| wrist_image 训练/评估不一致 | 中 | 训练有图，评估全黑（但云帆也是 NoWrist） |
| Pi0.5 base checkpoint 问题 | 中 | 可能 Pi0.5 base 不适合 ManiSkill |
| fsdp_devices=8 影响 | 低 | 多卡训练可能引入问题 |

## 下一步行动

### 方案 A：录制评估视频
录制视频观察机械臂实际行为，判断是不动、乱动还是差一点。

```bash
python scripts/eval_maniskill.py \
    --config-name pi05_maniskill_pickcube \
    --exp-name pickcube_sft_v1 \
    --env-id PickCube-v1 \
    --num-episodes 10 \
    --save-video True \
    --video-dir ./video_pickcube_debug
```

### 方案 B：修复配置重新训练
1. 改用 `LeRobotManiskillDataConfig`（带 wrist）
2. 改 `action_horizon=20` 与云帆一致
3. 重新训练

### 方案 C：修改评估脚本
添加 hand_camera 到评估环境，确保 wrist_image 有效。

## 相关文件

| 文件 | 说明 |
|------|------|
| `src/openpi/training/config.py:L480` | PickCube 训练配置 |
| `scripts/eval_maniskill.py:L98-122` | wrist_image 处理逻辑 |
| `debug_images/` | 评估时保存的调试图像 |
| `nohup.out` | 训练日志 |

## 参考：云帆的成功配置

```python
TrainConfig(
    name="pi0_maniskill_stackcube",
    model=pi0_config.Pi0Config(action_horizon=20),  # 注意是 20
    data=LeRobotManiskillDataConfig(  # 带 wrist 版本
        repo_id="...",
        base_config=DataConfig(prompt_from_task=True),
        extra_delta_transform=False,
    ),
    batch_size=256,
    ...
)
```
