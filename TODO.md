# éƒ­å¥•è¾° - OpenPi å®ä¹ ä»»åŠ¡æ¸…å•

> æ¥æºï¼š2025å¹´12æœˆ25æ—¥ä¼šè®®çºªè¦ï¼ˆç¨‹æ´ªæ´‹ã€å¨„äº‘å¸†ã€å¼ ä¹¦é€¸ï¼‰
> å¼€å§‹æ—¶é—´ï¼š2025å¹´12æœˆ26æ—¥

---

## ğŸ”§ Pi0 â†’ Pi0.5 è¿ç§»æ–¹æ¡ˆ

### æ ¸å¿ƒå·®å¼‚

| é…ç½®é¡¹ | Pi0 | Pi0.5 | è¯´æ˜ |
|--------|-----|-------|------|
| `pi05` | `False` | `True` | ä¸»å¼€å…³ |
| `max_token_len` | 48 | 200 | Token åºåˆ—é•¿åº¦ |
| `discrete_state_input` | `False` | `True` | çŠ¶æ€è¾“å…¥æ–¹å¼ |
| Checkpoint | `pi0_base` | `pi05_base` | é¢„è®­ç»ƒæƒé‡è·¯å¾„ |
| Action Expert | æ ‡å‡† RMSNorm | adaRMSNorm | æ³¨å…¥ flow matching timestep |

### è¿ç§»æ­¥éª¤

#### Step 1: ä¿®æ”¹ Config æ–‡ä»¶
æ‰¾åˆ° `src/openpi/training/config.py`ï¼Œå¤åˆ¶ä¸€ä»½ Pi0 çš„ configï¼ˆå¦‚ `pi0_libero`ï¼‰ï¼Œæ”¹ä¸ºï¼š

```python
@register_config
def pi05_custom() -> TrainConfig:
    return TrainConfig(
        name="pi05_custom",
        model=pi0_config.Pi0Config(
            pi05=True,  # å…³é”®ï¼šå¯ç”¨ Pi0.5 æ¨¡å¼
            # max_token_len å’Œ discrete_state_input ä¼šè‡ªåŠ¨è®¾ç½®
        ),
        weight_loader=weight_loaders.CheckpointWeightLoader(
            "gs://openpi-assets/checkpoints/pi05_base/params"  # Pi0.5 æƒé‡
        ),
        # ... å…¶ä»–é…ç½®
    )
```

#### Step 2: æ•°æ®é¢„å¤„ç†ï¼ˆé‡è¦ï¼‰
Pi0.5 ä½¿ç”¨ **åˆ†ä½æ•°å½’ä¸€åŒ–**ï¼Œéœ€è¦è¿è¡Œï¼š
```bash
python scripts/compute_norm_stats.py --config pi05_custom
```

#### Step 3: è®­ç»ƒå‘½ä»¤
```bash
python scripts/train.py --config pi05_custom
```

#### Step 4: æ¨ç†éªŒè¯
```bash
python scripts/serve_policy.py --config pi05_custom
```

### å…³é”®æ–‡ä»¶ä½ç½®

```
src/openpi/
â”œâ”€â”€ models/
â”‚   â”œâ”€â”€ pi0.py           # Pi0/Pi0.5 æ¨¡å‹å®ç°
â”‚   â”œâ”€â”€ pi0_config.py    # Pi0Config å®šä¹‰ï¼ˆpi05 å‚æ•°åœ¨è¿™é‡Œï¼‰
â”‚   â””â”€â”€ gemma.py         # Action Expert å®ç°
â”œâ”€â”€ training/
â”‚   â””â”€â”€ config.py        # æ‰€æœ‰è®­ç»ƒé…ç½®ï¼ˆåœ¨è¿™é‡Œåˆ›å»ºæ–° configï¼‰
â””â”€â”€ transforms/
    â””â”€â”€ transforms.py    # æ•°æ®é¢„å¤„ç†ï¼ˆå½’ä¸€åŒ–æ–¹å¼ï¼‰
```

---

## ğŸ“‹ å½“å‰ä»»åŠ¡

### 1. åŸºç¡€é…ç½®ä¿®æ”¹
- [x] æŸ¥æ‰¾ Pi 0.5 çš„ config æ–‡ä»¶ â†’ `src/openpi/training/config.py`
- [ ] åŸºäºå¨„äº‘å¸†å…±äº«çš„ config è¿›è¡Œä¿®æ”¹
- [x] å¯¹æ¯”å®˜æ–¹ä»“åº“çš„æ”¹åŠ¨å¤„ â†’ è§ä¸Šæ–¹è¿ç§»æ–¹æ¡ˆ
- [ ] å°†æ•°æ®é›†æ›¿æ¢æˆå¨„äº‘å¸†é€ å¥½çš„æ•°æ®é›†
- [ ] ä¸‹è½½ Pi 0.5 çš„ baseï¼ˆç­‰å¨„äº‘å¸†å®Œæˆä¸‹è½½åè·å–ï¼‰

### 2. ä»¿çœŸä»»åŠ¡ï¼ˆä¸Šæ‰‹ä»»åŠ¡ï¼‰
- [ ] å®Œæˆ 6 ä¸ªåœ¨ **ManiSkill** ä¸Šçš„ä»¿çœŸä»»åŠ¡
- [ ] å°† Pi 0 æ¥ ManiSkill çš„ä»¿çœŸ â†’ æ¢æˆ Pi 0.5 æ¥ ManiSkill çš„ä»¿çœŸ
- [ ] å®Œæˆ Pi 0.5 åœ¨ ManiSkill Benchmark çš„è·‘åˆ†

> **æ³¨**ï¼šManySkill/ManyScore å®é™…ä¸Šæ˜¯ **ManiSkill**ï¼ˆSAPIEN Manipulation Skill Frameworkï¼‰
> - GitHub: https://github.com/haosulab/ManiSkill
> - GPU å¹¶è¡Œæœºå™¨äººæ“ä½œä»¿çœŸå™¨å’ŒåŸºå‡†æµ‹è¯•å¹³å°

### 3. æ¶æ„æ›´æ”¹ä»»åŠ¡
- [ ] å°†å½“å‰æ¶æ„çš„åŠ¨ä½œå¤´æ¢æˆç®€å•çš„ Flow Matching å¤´ï¼ˆå‚ç…§ Pi 0 çš„è®¾è®¡ï¼‰
- [ ] å¾®è°ƒå‚æ•°ï¼šå½“å‰ loss æ˜¯ diffusion loss + a + q loss
- [ ] å¾®è°ƒ q ä½¿å…¶é€‚é… Flow Matching loss

### 4. å­¦ä¹ å‡†å¤‡
- [ ] é˜…è¯» CRFT è®ºæ–‡ï¼ˆç¨‹æ´ªæ´‹æ¨èï¼‰
- [ ] ç†Ÿæ‚‰æ³°ç²çš„ä»£ç ï¼ˆåŸºäº CRFT æ”¹è¿›ï¼‰

---

## â³ å¨„äº‘å¸†éœ€è¦æä¾›çš„å‰ç½®ææ–™

> **å‘ç»™äº‘å¸†ç¡®è®¤è¿›åº¦ç”¨**

### å¿…é¡»ææ–™ï¼ˆé˜»å¡æˆ‘å¼€å§‹å·¥ä½œï¼‰

| # | ææ–™ | è¯´æ˜ | æˆ‘æ‹¿åˆ°ååšä»€ä¹ˆ | çŠ¶æ€ |
|---|------|------|----------------|------|
| 1 | **ä½ ä¿®æ”¹è¿‡çš„ config æ–‡ä»¶** | åŸºäº Pi 0 æ”¹çš„é‚£ä»½ | å¯¹æ¯”å®˜æ–¹æ”¹åŠ¨ï¼Œç†è§£ä½ ä»¬çš„å®šåˆ¶åŒ–é…ç½® | â³ |
| 2 | **é€ å¥½çš„æ•°æ®é›†** | æ›¿æ¢å®˜æ–¹æ•°æ®é›†ç”¨ | åœ¨ config é‡ŒæŒ‡å‘è¿™ä¸ªæ•°æ®é›†è·¯å¾„ | â³ |
| 3 | **Pi 0.5 base æƒé‡** | ä½ è¯´ 12/25 ä¸‹è½½å®Œæˆ | æ”¾åˆ°é›†ç¾¤ä¸Šï¼Œconfig æŒ‡å‘è¿™ä¸ªè·¯å¾„ | â³ |
| 4 | **ManiSkill ä»¿çœŸä»£ç ** | 6 ä¸ªä»¿çœŸä»»åŠ¡çš„ä»£ç  | è·‘é€šåæ”¹æˆ Pi 0.5 | â³ |
| 5 | **Pi 0 æ¥ ManiSkill ä»¿çœŸä»£ç ** | ç°æœ‰çš„ Pi 0 ç‰ˆæœ¬ | æ”¹æˆ Pi 0.5 ç‰ˆæœ¬ | â³ |

### å»ºè®®ææ–™ï¼ˆåŠ é€Ÿæˆ‘ä¸Šæ‰‹ï¼‰

| # | ææ–™ | è¯´æ˜ | çŠ¶æ€ |
|---|------|------|------|
| 6 | **è¯¦ç»†ä»»åŠ¡è¯´æ˜æ–‡æ¡£** | åŒ…æ‹¬ä¿®æ”¹ä½ç½®ã€å‚æ•°ã€é¢„æœŸç»“æœ | â³ |
| 7 | **Pi 0 çš„ Flow Matching è®¾è®¡å‚è€ƒ** | æ¶æ„ä»»åŠ¡è¦ç”¨ | â³ |

### ä¾èµ–å…³ç³»

```
äº‘å¸†æä¾› config + æ•°æ®é›† + æƒé‡
         â†“
    æˆ‘ä¿®æ”¹ configï¼Œè·‘é€šè®­ç»ƒ
         â†“
äº‘å¸†æä¾› ManiSkill ä»¿çœŸä»£ç 
         â†“
    æˆ‘è·‘é€š 6 ä¸ªä»¿çœŸä»»åŠ¡
         â†“
äº‘å¸†æä¾› Pi0 æ¥ ManiSkill ä»£ç 
         â†“
    æˆ‘æ”¹æˆ Pi0.5 ç‰ˆæœ¬å¹¶è·‘åˆ†
```

---

## â³ ç¨‹æ´ªæ´‹éœ€è¦æä¾›

| å¾…åŠ | çŠ¶æ€ | å¤‡æ³¨ |
|------|------|------|
| æœ‰å¡çš„é›†ç¾¤è´¦å· | â³ | 12/26 ä¸Šåˆ |

---

## ğŸ¯ åç»­è§„åˆ’

- å¦‚æœå‰ä¸¤é¡¹ä»»åŠ¡æ•ˆæœå¥½ â†’ ä¼šæœ‰è¿›ä¸€æ­¥è¿ç§»ä»»åŠ¡
- **Robobrain é¡¹ç›®**: Robot è¿™è¾¹çš„ VLM é€šç”¨åŸºåº§é¡¹ç›®
  - ç›®æ ‡ï¼šå†²å‡»é¡¶å°–æœŸåˆŠ
  - å†…å¿ƒç›®æ ‡ï¼šScience

---

## ğŸ“ è¿›åº¦è®°å½•

### 2025-12-26
- [x] Fork openpi ä»“åº“åˆ°ä¸ªäººè´¦æˆ·
- [x] åˆ›å»º TODO.md ä»»åŠ¡æ¸…å•
- [x] è°ƒç ” Pi0 â†’ Pi0.5 è¿ç§»æ–¹æ¡ˆ
- [x] ç¡®è®¤ ManiSkill åŸºå‡†æµ‹è¯•å¹³å°

---

## ğŸ”— ç›¸å…³èµ„æº

- **ä»“åº“åœ°å€**: https://github.com/EasonAI-5589/openpi
- **å®˜æ–¹ä»“åº“**: https://github.com/Physical-Intelligence/openpi
- **ä¼šè®®çºªè¦**: https://jwolpxeehx.feishu.cn/docx/NdiNdlHobooUZYxBo95ckA0fn2e
- **ManiSkill**: https://github.com/haosulab/ManiSkill

---

## ğŸ’¬ äº¤æµæ²Ÿé€š

- æœ‰é—®é¢˜åœ¨ç¾¤é‡Œç›´æ¥å‘
- å¤šä¸å¨„äº‘å¸†å’Œä¹¦é€¸äº¤æµ

---

## ğŸ“š Preliminary: Diffusion vs Flow Matching

> æ¶æ„æ›´æ”¹ä»»åŠ¡çš„èƒŒæ™¯çŸ¥è¯†ï¼šç†è§£ä¸ºä»€ä¹ˆè¦æŠŠåŠ¨ä½œå¤´æ¢æˆ Flow Matching

### 1. é—®é¢˜èƒŒæ™¯ï¼šæœºå™¨äººåŠ¨ä½œç”Ÿæˆ

æœºå™¨äººæ§åˆ¶éœ€è¦ç”Ÿæˆ**è¿ç»­çš„åŠ¨ä½œåºåˆ—**ï¼ˆå¦‚å…³èŠ‚è§’åº¦ã€æœ«ç«¯æ‰§è¡Œå™¨ä½ç½®ï¼‰ã€‚ä¼ ç»Ÿæ–¹æ³•ç›´æ¥å›å½’åŠ¨ä½œï¼Œä½†å­˜åœ¨é—®é¢˜ï¼š
- åŠ¨ä½œåˆ†å¸ƒæ˜¯**å¤šæ¨¡æ€**çš„ï¼ˆåŒä¸€ä¸ªä»»åŠ¡å¯èƒ½æœ‰å¤šç§å®Œæˆæ–¹å¼ï¼‰
- éœ€è¦ç”Ÿæˆ**å¹³æ»‘è¿ç»­**çš„è½¨è¿¹
- è¦èƒ½å¤„ç†**ä¸ç¡®å®šæ€§**

**ç”Ÿæˆæ¨¡å‹**ï¼ˆDiffusion/Flow Matchingï¼‰å¯ä»¥è§£å†³è¿™äº›é—®é¢˜ï¼šä»å™ªå£°ä¸­"ç”Ÿæˆ"åŠ¨ä½œã€‚

---

### 2. Diffusion Modelï¼ˆæ‰©æ•£æ¨¡å‹ï¼‰

#### 2.1 æ ¸å¿ƒæ€æƒ³

```
å‰å‘è¿‡ç¨‹ï¼ˆåŠ å™ªï¼‰ï¼šx_0 â†’ x_1 â†’ x_2 â†’ ... â†’ x_Tï¼ˆçº¯å™ªå£°ï¼‰
åå‘è¿‡ç¨‹ï¼ˆå»å™ªï¼‰ï¼šx_T â†’ x_{T-1} â†’ ... â†’ x_0ï¼ˆå¹²å‡€æ•°æ®ï¼‰
```

#### 2.2 æ•°å­¦å½¢å¼

**å‰å‘è¿‡ç¨‹**ï¼ˆå›ºå®šçš„é©¬å°”å¯å¤«é“¾ï¼‰ï¼š
```
q(x_t | x_{t-1}) = N(x_t; âˆš(1-Î²_t) x_{t-1}, Î²_t I)
```
- `Î²_t` æ˜¯å™ªå£°è°ƒåº¦ï¼ˆnoise scheduleï¼‰ï¼Œæ§åˆ¶æ¯æ­¥åŠ å¤šå°‘å™ªå£°
- ç»è¿‡ T æ­¥åï¼Œ`x_T â‰ˆ N(0, I)`ï¼ˆè¿‘ä¼¼æ ‡å‡†é«˜æ–¯ï¼‰

**åå‘è¿‡ç¨‹**ï¼ˆéœ€è¦å­¦ä¹ ï¼‰ï¼š
```
p_Î¸(x_{t-1} | x_t) = N(x_{t-1}; Î¼_Î¸(x_t, t), Î£_Î¸(x_t, t))
```
- æ¨¡å‹å­¦ä¹ é¢„æµ‹ `Î¼_Î¸`ï¼ˆå»å™ªåçš„å‡å€¼ï¼‰
- å®é™…ä¸­å¸¸ç”¨ **Îµ-prediction**ï¼šé¢„æµ‹å™ªå£° Îµï¼Œç„¶åè®¡ç®— Î¼

#### 2.3 è®­ç»ƒç›®æ ‡

```python
# DDPM é£æ ¼çš„è®­ç»ƒ
Îµ = random_noise()
x_t = âˆš(á¾±_t) * x_0 + âˆš(1-á¾±_t) * Îµ   # ä¸€æ­¥åŠ å™ªåˆ° t
Îµ_pred = model(x_t, t)               # é¢„æµ‹å™ªå£°
loss = MSE(Îµ_pred, Îµ)                # é‡å»ºå™ªå£°
```

#### 2.4 é‡‡æ ·è¿‡ç¨‹

```python
x_T = random_noise()
for t in range(T, 0, -1):
    Îµ_pred = model(x_t, t)
    x_{t-1} = denoise_step(x_t, Îµ_pred, t)  # å¤æ‚çš„å»å™ªå…¬å¼
return x_0
```

#### 2.5 é—®é¢˜

| é—®é¢˜ | è¯´æ˜ |
|------|------|
| **é‡‡æ ·æ…¢** | éœ€è¦ T æ­¥ï¼ˆé€šå¸¸ 100-1000 æ­¥ï¼‰ |
| **å™ªå£°è°ƒåº¦å¤æ‚** | Î²_t çš„è®¾è®¡å½±å“å¾ˆå¤§ï¼Œéœ€è¦è°ƒå‚ |
| **æ•°å­¦å¤æ‚** | æ¶‰åŠ SDE/ODE ç†è®º |

---

### 3. Flow Matchingï¼ˆæµåŒ¹é…ï¼‰

#### 3.1 æ ¸å¿ƒæ€æƒ³

ä¸å†"é€æ­¥å»å™ª"ï¼Œè€Œæ˜¯å­¦ä¹ ä¸€ä¸ª**å‘é‡åœº**ï¼ˆvelocity fieldï¼‰ï¼Œç›´æ¥æè¿°ä»å™ªå£°åˆ°æ•°æ®çš„"æµåŠ¨"æ–¹å‘ã€‚

```
æ•°æ®ç‚¹ x_0 å’Œå™ªå£°ç‚¹ x_1 ä¹‹é—´å­˜åœ¨ä¸€æ¡"æµåŠ¨è·¯å¾„"
æ¨¡å‹å­¦ä¹ ï¼šåœ¨è·¯å¾„ä¸Šä»»æ„ä¸€ç‚¹ x_tï¼Œå¾€å“ªä¸ªæ–¹å‘èµ°ï¼Ÿ
```

#### 3.2 æ•°å­¦å½¢å¼

**çº¿æ€§æ’å€¼è·¯å¾„**ï¼ˆæœ€ç®€å•çš„å½¢å¼ï¼‰ï¼š
```
x_t = t * x_1 + (1 - t) * x_0
    = t * noise + (1 - t) * data
```
- `t=0`ï¼šçº¯æ•°æ®
- `t=1`ï¼šçº¯å™ªå£°
- `tâˆˆ(0,1)`ï¼šä¸­é—´çŠ¶æ€

**ç›®æ ‡å‘é‡åœº**ï¼ˆçœŸå®çš„"æµåŠ¨æ–¹å‘"ï¼‰ï¼š
```
u_t = dx_t/dt = x_1 - x_0 = noise - data
```

**æ¨¡å‹é¢„æµ‹**ï¼š
```
v_Î¸(x_t, t) â‰ˆ u_t
```

#### 3.3 è®­ç»ƒç›®æ ‡

```python
# Flow Matching è®­ç»ƒï¼ˆæå…¶ç®€å•ï¼ï¼‰
noise = random_noise()
t = random_uniform(0, 1)              # éšæœºé‡‡æ ·æ—¶é—´æ­¥
x_t = t * noise + (1 - t) * data      # çº¿æ€§æ’å€¼
u_t = noise - data                    # ç›®æ ‡å‘é‡
v_t = model(x_t, t)                   # æ¨¡å‹é¢„æµ‹
loss = MSE(v_t, u_t)                  # å°±æ˜¯è¿™ä¹ˆç®€å•
```

#### 3.4 é‡‡æ ·è¿‡ç¨‹ï¼ˆODE ç§¯åˆ†ï¼‰

```python
x = noise  # ä» t=1 å¼€å§‹
dt = -1.0 / num_steps

for step in range(num_steps):
    t = 1.0 - step * abs(dt)
    v = model(x, t)      # é¢„æµ‹å‘é‡åœº
    x = x + dt * v       # æ¬§æ‹‰ç§¯åˆ†

return x  # t=0 æ—¶å¾—åˆ°å¹²å‡€æ•°æ®
```

---

### 4. å¯¹æ¯”ï¼šä¸ºä»€ä¹ˆ Flow Matching æ›´å¥½ï¼Ÿ

| ç»´åº¦ | Diffusion | Flow Matching |
|------|-----------|---------------|
| **è®­ç»ƒç›®æ ‡** | é¢„æµ‹å™ªå£° Îµ | é¢„æµ‹é€Ÿåº¦ v |
| **æ•°å­¦å¤æ‚åº¦** | é«˜ï¼ˆSDE/é©¬å°”å¯å¤«é“¾ï¼‰ | ä½ï¼ˆçº¿æ€§æ’å€¼ï¼‰ |
| **å™ªå£°è°ƒåº¦** | éœ€è¦è®¾è®¡ Î²_t | ä¸éœ€è¦ |
| **é‡‡æ ·æ­¥æ•°** | é€šå¸¸ 20-100 æ­¥ | å¯ä»¥ 5-20 æ­¥ |
| **é‡‡æ ·é€Ÿåº¦** | æ…¢ | **å¿«** |
| **ä»£ç å®ç°** | å¤æ‚ | **ç®€å•** |
| **ç†è®ºåŸºç¡€** | å»å™ªå¾—åˆ†åŒ¹é… | è¿ç»­å½’ä¸€åŒ–æµ |

---

### 5. Pi0 ä¸­çš„ Flow Matching å®ç°

#### 5.1 è®­ç»ƒä»£ç ï¼ˆ`pi0.py`ï¼‰

```python
def compute_loss(self, rng, observation, actions, train=False):
    # 1. é‡‡æ ·å™ªå£°
    noise = jax.random.normal(noise_rng, actions.shape)

    # 2. é‡‡æ ·æ—¶é—´æ­¥ï¼ˆBeta åˆ†å¸ƒï¼Œåå‘ä½ tï¼‰
    time = jax.random.beta(time_rng, 1.5, 1) * 0.999 + 0.001

    # 3. çº¿æ€§æ’å€¼å¾—åˆ° x_t
    x_t = time * noise + (1 - time) * actions

    # 4. ç›®æ ‡å‘é‡
    u_t = noise - actions

    # 5. æ¨¡å‹é¢„æµ‹
    v_t = self.forward(observation, x_t, time)

    # 6. MSE Loss
    return jnp.mean(jnp.square(v_t - u_t), axis=-1)
```

#### 5.2 é‡‡æ ·ä»£ç ï¼ˆ`pi0.py`ï¼‰

```python
def sample_actions(self, rng, observation, num_steps=10):
    dt = -1.0 / num_steps
    x = random_noise()  # ä»å™ªå£°å¼€å§‹
    time = 1.0

    while time >= 0:
        v_t = self.forward(observation, x, time)
        x = x + dt * v_t  # æ¬§æ‹‰ç§¯åˆ†
        time = time + dt

    return x
```

#### 5.3 å…³é”®è®¾è®¡é€‰æ‹©

| è®¾è®¡ | Pi0 çš„é€‰æ‹© | åŸå›  |
|------|-----------|------|
| æ—¶é—´é‡‡æ · | `Beta(1.5, 1)` | åå‘ä½ tï¼ˆæ›´æ¥è¿‘å™ªå£°çš„åŒºåŸŸæ›´éš¾ï¼‰ |
| ç§¯åˆ†æ­¥æ•° | 10 æ­¥ | è¶³å¤Ÿç²¾åº¦ï¼Œ50Hz å®æ—¶æ€§ |
| æ—¶é—´æ³¨å…¥ | æ‹¼æ¥åˆ° action token | ç®€å•æœ‰æ•ˆ |

---

### 6. Pi0 vs Pi0.5 çš„ Flow Matching åŒºåˆ«

| éƒ¨åˆ† | Pi0 | Pi0.5 |
|------|-----|-------|
| æ—¶é—´æ­¥æ³¨å…¥ | MLP æ‹¼æ¥ | **adaRMSNorm** |
| çŠ¶æ€è¾“å…¥ | è¿ç»­ tokenï¼ˆsuffixï¼‰ | ç¦»æ•£ tokenï¼ˆprefixï¼‰ |

**adaRMSNorm**ï¼ˆè‡ªé€‚åº” RMS å½’ä¸€åŒ–ï¼‰ï¼š

```python
# Pi0: æ—¶é—´ä¿¡æ¯é€šè¿‡æ‹¼æ¥æ³¨å…¥
action_time_tokens = concat([action_tokens, time_tokens])
action_time_tokens = MLP(action_time_tokens)

# Pi0.5: æ—¶é—´ä¿¡æ¯é€šè¿‡è°ƒåˆ¶å½’ä¸€åŒ–å‚æ•°æ³¨å…¥
time_emb = time_MLP(timestep)
# åœ¨ Transformer çš„æ¯ä¸ª RMSNorm å±‚ï¼š
output = RMSNorm(input) * (1 + scale(time_emb)) + shift(time_emb)
```

adaRMSNorm çš„å¥½å¤„ï¼š
- æ—¶é—´ä¿¡æ¯æ¸—é€åˆ°ç½‘ç»œçš„æ¯ä¸€å±‚
- ç±»ä¼¼ DiTï¼ˆDiffusion Transformerï¼‰çš„è®¾è®¡
- æ›´å¥½çš„æ¡ä»¶æ§åˆ¶

---

### 7. ä½ çš„ä»»åŠ¡ï¼šæ¢ Flow Matching å¤´

æ ¹æ®ä¼šè®®çºªè¦ï¼Œå½“å‰æ¶æ„å¯èƒ½ç”¨çš„æ˜¯ Diffusionï¼ˆæˆ–å…¶ä»–å˜ä½“ï¼‰ï¼Œéœ€è¦ï¼š

1. **ç†è§£å½“å‰ loss ç»„æˆ**
   - `diffusion loss`ï¼šåº”è¯¥æ˜¯ Îµ-prediction çš„ MSE
   - `a loss` å’Œ `q loss`ï¼šå¯èƒ½æ˜¯è¾…åŠ©ä»»åŠ¡ï¼ˆéœ€è¦çœ‹ä»£ç ç¡®è®¤ï¼‰

2. **æ›¿æ¢ä¸º Flow Matching**
   - æ ¸å¿ƒæ”¹åŠ¨ï¼š`Îµ-prediction` â†’ `v-prediction`
   - ç®€åŒ–è®­ç»ƒç›®æ ‡ä¸ºçº¯ MSE
   - å¯èƒ½éœ€è¦è°ƒæ•´è¾…åŠ© loss çš„æƒé‡

3. **å‚è€ƒ Pi0 çš„å®ç°**
   - `src/openpi/models/pi0.py` çš„ `compute_loss` å’Œ `sample_actions`

---

### 8. å‚è€ƒèµ„æ–™

- **Pi0 è®ºæ–‡**: [arXiv:2410.24164](https://arxiv.org/abs/2410.24164)
- **Flow Matching åŸè®ºæ–‡**: [Flow Matching for Generative Modeling](https://arxiv.org/abs/2210.02747)
- **Rectified Flow**: [Flow Straight and Fast](https://arxiv.org/abs/2209.03003)
- **openpi æºç **: `src/openpi/models/pi0.py`
